<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prova AJAX Codice Fiscale</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        #risultato {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">

        <h2 style="text-align: center;">Prova AJAX Codice Fiscale</h2>
        <h3 style="text-align: center;"><i>Inserisci il tuo CF per ottenere l'anno di nascita</i></h3>
        <br>

        <input type="text" id="cf" placeholder="Inserisci il tuo Codice Fiscale">
        <button onclick="inviaDati()">Invia</button>

        <div id="risultato"></div>
    </div>

    <script>

        function inviaDati() {
            const cf = document.getElementById('cf').value;
            const risultato = document.getElementById('risultato');

            if (!cf) {
                alert('Inserisci un Codice Fiscale!');
                return;
            }

            if (!validaCodiceFiscale(cf)) {
                alert('Codice Fiscale non valido!');
                return;
            }

            // Creare l'oggetto XMLHttpRequest
            const xhr = new XMLHttpRequest();

            // Configurare la richiesta
            xhr.open('POST', 'php_handler.php', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            // Gestire la risposta
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Mostrare direttamente la risposta del PHP
                    risultato.innerHTML = xhr.responseText;
                    risultato.style.display = 'block';
                }
            };

            // Inviare i dati
            xhr.send('cf=' + cf);
        }

        // function validaCodiceFiscale(cf) {

        //     cf = cf.toUpperCase().trim();

        //     // 1. Controllo lunghezza e caratteri (Regex)
        //     const regex = /^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$/;
        //     if (cf.length !== 16 || !regex.test(cf)) {
        //         return false; // Formato errato
        //     }

        //     // 2. Algoritmo di validazione del codice di controllo (checksum)
        //     const setPari = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        //     const setDisp = "BAKPLCQDREVOSFTGUHMINJWZYX";
        //     let s = 0;

        //     // Caratteri dispari (indici 1, 3, 5, 7, 9, 11, 13)
        //     for (let i = 1; i <= 13; i += 2) {
        //         s += setPari.indexOf(cf.charAt(i));
        //     }

        //     // Caratteri pari (indici 0, 2, 4, 6, 8, 10, 12, 14)
        //     for (let i = 0; i <= 14; i += 2) {
        //         s += setDisp.indexOf(cf.charAt(i));
        //     }

        //     // Confronto con il carattere di controllo (indice 15)
        //     if (s % 26 !== cf.charCodeAt(15) - 'A'.charCodeAt(0)) {
        //         return false; // Checksum non valido
        //     }

        //     return true; // Codice Fiscale valido (formalmente e per checksum)
        // }

        function validaCodiceFiscale(cf) {
            cf = cf.toUpperCase().trim();

            const regex = /^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$/;
            if (!regex.test(cf)) return false;

            const pari = {
                '0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
                'A':0,'B':1,'C':2,'D':3,'E':4,'F':5,'G':6,'H':7,'I':8,'J':9,
                'K':10,'L':11,'M':12,'N':13,'O':14,'P':15,'Q':16,'R':17,'S':18,'T':19,
                'U':20,'V':21,'W':22,'X':23,'Y':24,'Z':25
            };

            const dispari = {
                '0':1,'1':0,'2':5,'3':7,'4':9,'5':13,'6':15,'7':17,'8':19,'9':21,
                'A':1,'B':0,'C':5,'D':7,'E':9,'F':13,'G':15,'H':17,'I':19,'J':21,
                'K':2,'L':4,'M':18,'N':20,'O':11,'P':3,'Q':6,'R':8,'S':12,'T':14,
                'U':16,'V':10,'W':22,'X':25,'Y':24,'Z':23
            };

            let somma = 0;

            for (let i = 0; i < 15; i++) {
                const c = cf[i];
                if ((i + 1) % 2 === 0) {
                    somma += pari[c];
                } else {
                    somma += dispari[c];
                }
            }

            const controllo = String.fromCharCode((somma % 26) + 65);
            return controllo === cf[15];
        }

    </script>

</body>
</html>